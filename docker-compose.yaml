services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - USER_UID=${USER_UID:-1000}
        - USER_GID=${USER_GID:-1000}
        - DOCKER_GID=${DOCKER_GID:-999}
    hostname: kube-sandbox
    env_file:
      - .env
    volumes:
      # Mount the project directory
      - ${WORKSPACE_DIR:-.}:/workspace
      # Claude config (for user-level CLAUDE.md)
      - ${HOME}/.claude/CLAUDE.md:/home/node/.claude/CLAUDE.md:ro
      # AWS credentials (read-only)
      - ${HOME}/.aws:/home/node/.aws:ro
      # Persist home settings
      - home:/home/node
      # Access to docker
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Dev container marker
      - DEV_CONTAINER=true
      # Customizations
      - TERM=xterm-256color
      # AWS environment variables (if using env vars instead of credentials file)
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - AWS_REGION=${AWS_REGION:-ap-east-2}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-ap-east-2}
      # Terraform
      - TF_PLUGIN_CACHE_DIR=/home/node/.terraform.d/plugin-cache
    working_dir: /workspace
    stdin_open: true
    tty: true
    # Run as node user
    user: node
    # Use tini as init (already set in Dockerfile, but explicit here too)
    init: true
    # Required for rootless Podman
    devices:
      - /dev/fuse
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

volumes:
    home:
